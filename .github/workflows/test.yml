name: Test

on:
  pull_request:
    branches: [ main ]

permissions:
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - run: npm ci
    
    - name: Run Tests
      id: test
      run: npm test > test_output.txt 2>&1
      continue-on-error: true

    - name: Post Test Results
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          try {
            const output = fs.readFileSync('test_output.txt', 'utf8');
            const outcome = '${{ steps.test.outcome }}' === 'success' ? '✅ Passed' : '❌ Failed';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### Test Results (Node ${{ matrix.node-version }})\n\n${outcome}\n\n<details><summary>Show Output</summary>\n\n\`\`\`\n${output}\n\`\`\`\n</details>`
            });
          } catch (error) {
            console.error('Error posting comment:', error);
          }

    - name: Fail if tests failed
      if: steps.test.outcome == 'failure'
      run: exit 1
