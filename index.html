<!DOCTYPE html>
<html lang="de" class="light">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
		/>
		<title>Drachenboot Planer</title>

		<!-- Social Share Meta Tags -->
		<meta
			property="og:title"
			content="Drachenboot Planer - Team Manager"
		/>
		<meta
			property="og:description"
			content="Verwalte dein Drachenboot-Team, plane Trainings und optimiere die Bootsbesetzung."
		/>
		<meta
			property="og:image"
			content="https://cdn-icons-png.flaticon.com/512/2043/2043693.png"
		/>
		<meta name="theme-color" content="#2563eb" />

		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>
		<script>
			tailwind.config = {
				darkMode: 'class',
				theme: {
					extend: {
						fontFamily: { sans: ['Inter', 'sans-serif'] },
					},
				},
			};
		</script>

		<!-- React & ReactDOM -->
		<script
			crossorigin
			src="https://unpkg.com/react@18/umd/react.production.min.js"
		></script>
		<script
			crossorigin
			src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
		></script>

		<!-- Babel -->
		<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

		<!-- Lucide Icons (Fixed Version) -->
		<script src="https://unpkg.com/lucide-react@0.468.0/dist/umd/lucide-react.min.js"></script>

		<!-- Html2Canvas -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

		<style>
			body {
				-webkit-tap-highlight-color: transparent;
			}
			/* Custom Scrollbar */
			::-webkit-scrollbar {
				width: 6px;
				height: 6px;
			}
			::-webkit-scrollbar-track {
				background: transparent;
			}
			::-webkit-scrollbar-thumb {
				background: #cbd5e1;
				border-radius: 3px;
			}
			.dark ::-webkit-scrollbar-thumb {
				background: #475569;
			}
		</style>
	</head>
	<body
		class="bg-slate-100 dark:bg-slate-950 text-slate-800 dark:text-slate-100 transition-colors duration-300"
	>
		<div id="root"></div>

		<script type="text/babel">
			const { useState, useMemo, useEffect, useCallback, useRef } = React;

			// Zugriff auf die Icons √ºber das globale 'lucide' Objekt
			const {
				User,
				Plus,
				Trash2,
				X,
				Anchor,
				Drum,
				ArrowRightLeft,
				ArrowUpFromLine,
				Save,
				RotateCcw,
				Wand2,
				RefreshCw,
				AlertCircle,
				Users,
				Pin,
				Calendar,
				Check,
				HelpCircle,
				ChevronRight,
				ArrowLeft,
				Pencil,
				XCircle,
				ShipWheel,
				Home,
				Settings,
				Camera,
				Target,
				Moon,
				Sun,
				Info,
				Crosshair,
				Scale,
			} = window.lucide;

			/**
			 * --- LOCAL STORAGE DATABASE ---
			 */
			const db = {
				KEY: 'drachenboot_pwa_data_v3',
				load: () => {
					try {
						const data = localStorage.getItem('drachenboot_pwa_data_v3');
						if (data) return JSON.parse(data);
					} catch (e) {
						console.error('Ladefehler', e);
					}
					return null;
				},
				save: (data) => {
					try {
						localStorage.setItem(
							'drachenboot_pwa_data_v3',
							JSON.stringify(data)
						);
					} catch (e) {
						console.error('Speicherfehler', e);
					}
				},
			};

			// --- COMPONENTS ---

			const DragonLogo = ({ className }) => (
				<svg
					viewBox="0 0 100 100"
					className={className}
					fill="none"
					stroke="currentColor"
					strokeWidth="2"
					strokeLinecap="round"
					strokeLinejoin="round"
				>
					<path
						d="M 20 80 Q 30 90, 50 85 Q 70 80, 75 60 Q 80 40, 60 35 Q 40 30, 35 50 Q 30 70, 50 75"
						className="text-blue-600 dark:text-blue-400"
						fill="currentColor"
						fillOpacity="0.1"
						strokeWidth="2.5"
					/>
					<path
						d="M 60 35 Q 50 15, 30 20 Q 15 25, 25 40 Q 35 55, 55 50"
						className="text-blue-700 dark:text-blue-300"
						fill="currentColor"
						fillOpacity="0.2"
					/>
					<circle
						cx="32"
						cy="28"
						r="2.5"
						fill="currentColor"
						className="text-slate-800 dark:text-slate-100"
					/>
					<path
						d="M 30 20 L 25 5"
						strokeWidth="2.5"
						className="text-blue-800 dark:text-blue-200"
					/>
					<path d="M 38 22 L 40 12" strokeWidth="2" />
					<path d="M 48 26 L 52 16" strokeWidth="2" />
					<path d="M 55 50 Q 65 55, 70 50" strokeWidth="2.5" />
					<path
						d="M 70 50 L 75 48 M 70 50 L 76 52 M 70 50 L 74 55"
						strokeWidth="2"
					/>
					<path
						d="M 65 45 C 65 40, 85 40, 85 45 L 85 65 C 85 70, 65 70, 65 65 Z"
						className="text-amber-600 dark:text-amber-500"
						fill="currentColor"
						fillOpacity="0.2"
						strokeWidth="2"
					/>
					<line
						x1="70"
						y1="50"
						x2="80"
						y2="50"
						strokeWidth="1.5"
						className="text-amber-700 dark:text-amber-300"
					/>
					<line
						x1="70"
						y1="56"
						x2="80"
						y2="56"
						strokeWidth="1.5"
						className="text-amber-700 dark:text-amber-300"
					/>
					<line
						x1="70"
						y1="62"
						x2="75"
						y2="62"
						strokeWidth="1.5"
						className="text-amber-700 dark:text-amber-300"
					/>
				</svg>
			);

			const OnboardingModal = ({ onClose }) => {
				const [step, setStep] = useState(0);
				const steps = [
					{
						title: 'Willkommen an Bord!',
						desc: 'Dein neuer Assistent f√ºr die Drachenboot-Planung. Verwalte dein Team, plane Trainings und optimiere die Bootsbesetzung.',
						icon: (
							<DragonLogo className="w-32 h-32 text-blue-600 dark:text-blue-400 mb-4" />
						),
					},
					{
						title: 'Team & Termine',
						desc: 'Lege deinen Kader an, definiere F√§higkeiten und erstelle Termine. Sportler k√∂nnen direkt zu- oder absagen.',
						icon: (
							<div className="flex gap-6 text-blue-600 dark:text-blue-400 mb-6 justify-center">
								<Users size={64} />
								<Calendar size={64} />
							</div>
						),
					},
					{
						title: 'Smarte Planung',
						desc: 'Der Auto-Fill Zauberstab berechnet automatisch die beste Sitzordnung basierend auf Gewicht, Skills und deinem gew√ºnschten Trimm.',
						icon: (
							<div className="flex gap-6 text-blue-600 dark:text-blue-400 mb-6 justify-center">
								<ShipWheel size={64} />
								<Wand2 size={64} />
							</div>
						),
					},
				];
				return (
					<div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-in fade-in duration-300">
						<div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden flex flex-col text-center relative">
							<div className="p-8 flex flex-col items-center pt-12 pb-8 min-h-[400px]">
								<div className="flex-1 flex flex-col items-center justify-center w-full">
									{steps[step].icon}
									<h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-3">
										{steps[step].title}
									</h2>
									<p className="text-slate-600 dark:text-slate-300 leading-relaxed">
										{steps[step].desc}
									</p>
								</div>
								<div className="w-full mt-8">
									<div className="flex justify-center gap-2 mb-6">
										{steps.map((_, i) => (
											<div
												key={i}
												className={`h-2 rounded-full transition-all duration-300 ${
													i === step
														? 'w-8 bg-blue-600'
														: 'w-2 bg-slate-200 dark:bg-slate-700'
												}`}
											/>
										))}
									</div>
									<button
										onClick={() =>
											step < steps.length - 1
												? setStep(step + 1)
												: onClose()
										}
										className="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold text-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 dark:shadow-none active:scale-[0.98]"
									>
										{step === steps.length - 1 ? "Los geht's!" : 'Weiter'}
									</button>
								</div>
							</div>
						</div>
					</div>
				);
			};

			const HelpModal = ({ onClose }) => (
				<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
					<div className="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
						<div className="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
							<h2 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
								<Info size={20} className="text-blue-500" /> Hilfe &
								Anleitung
							</h2>
							<button
								onClick={onClose}
								className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors text-slate-500"
							>
								<X size={20} />
							</button>
						</div>
						<div className="p-6 overflow-y-auto space-y-6 text-sm text-slate-600 dark:text-slate-300">
							<section>
								<h3 className="font-bold text-slate-900 dark:text-white text-base mb-2 flex items-center gap-2">
									üëã Allgemein
								</h3>
								<p>
									Willkommen im Drachenboot Planer! Diese App hilft dir,
									dein Team zu verwalten, Trainings zu planen und die
									optimale Bootsbesetzung zu berechnen.
								</p>
							</section>
							<section>
								<h3 className="font-bold text-slate-900 dark:text-white text-base mb-2 flex items-center gap-2">
									<Users size={18} /> 1. Team & Kader
								</h3>
								<ul className="list-disc pl-5 space-y-1">
									<li>
										<strong>Kader verwalten:</strong> F√ºge neue Mitglieder
										hinzu, bearbeite oder l√∂sche sie.
									</li>
									<li>
										<strong>Skills:</strong> Weise Rollen zu. Nur
										"Trommel"/"Steuer"-Skills werden vom Auto-Fill auf
										diese Pl√§tze gesetzt.
									</li>
								</ul>
							</section>
							<section>
								<h3 className="font-bold text-slate-900 dark:text-white text-base mb-2 flex items-center gap-2">
									<Calendar size={18} /> 2. Termine
								</h3>
								<ul className="list-disc pl-5 space-y-1">
									<li>Erstelle Termine und verwalte Zu-/Absagen.</li>
									<li>
										Mit "Planen" √∂ffnest du die Bootsansicht f√ºr diesen
										Termin.
									</li>
								</ul>
							</section>
							<section>
								<h3 className="font-bold text-slate-900 dark:text-white text-base mb-2 flex items-center gap-2">
									<Wand2 size={18} /> 3. Auto-Fill & Ziel-Trimm
								</h3>
								<ul className="list-disc pl-5 space-y-1">
									<li>
										<strong>Ziel-Slider:</strong> Stelle ein, ob das Boot
										hecklastig (-kg) oder buglastig (+kg) sein soll.
									</li>
									<li>
										<strong>Auto-Fill:</strong> Die KI verteilt die
										Besatzung so, dass dieser Zielwert erreicht wird.
									</li>
								</ul>
							</section>
							<section>
								<h3 className="font-bold text-slate-900 dark:text-white text-base mb-2 flex items-center gap-2">
									<Scale size={18} /> 4. Schwerpunkt
								</h3>
								<p>
									Der{' '}
									<span className="text-red-500 font-bold">
										rote Punkt
									</span>{' '}
									im Boot zeigt den aktuellen physikalischen Schwerpunkt
									an.
								</p>
							</section>
						</div>
						<div className="p-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50 text-center">
							<button
								onClick={onClose}
								className="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors"
							>
								Verstanden
							</button>
						</div>
					</div>
				</div>
			);

			const ImprintModal = ({ onClose }) => (
				<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
					<div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col">
						<div className="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
							<h2 className="text-lg font-bold text-slate-800 dark:text-white">
								Impressum
							</h2>
							<button
								onClick={onClose}
								className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors text-slate-500"
							>
								<X size={20} />
							</button>
						</div>
						<div className="p-6 text-sm text-slate-600 dark:text-slate-300 space-y-4">
							<div>
								<h3 className="font-bold text-slate-900 dark:text-white mb-1">
									Angaben gem√§√ü ¬ß 5 TMG
								</h3>
								<p>Jan Hartje</p>
								<p>Hamburger Allee 6</p>
								<p>30161 Hannover</p>
							</div>
							<div>
								<h3 className="font-bold text-slate-900 dark:text-white mb-1">
									Kontakt
								</h3>
								<p>E-Mail: info@janhartje.com</p>
							</div>
							<div className="text-xs text-slate-400 mt-4">
								<p>
									Dies ist ein privates Projekt zur Planung von
									Drachenboot-Teams.
								</p>
							</div>
						</div>
					</div>
				</div>
			);

			const DrachenbootPlaner = () => {
				const [view, setView] = useState('team');
				const [activeEventId, setActiveEventId] = useState(null);
				const [isLoading, setIsLoading] = useState(true);
				const [isExporting, setIsExporting] = useState(false);
				const [isDarkMode, setIsDarkMode] = useState(false);
				const [showHelp, setShowHelp] = useState(false);
				const [showImprint, setShowImprint] = useState(false);
				const [showOnboarding, setShowOnboarding] = useState(false);
				const boatRef = useRef(null);
				const [deleteConfirmId, setDeleteConfirmId] = useState(null);

				const [paddlers, setPaddlers] = useState([]);
				const [events, setEvents] = useState([]);
				const [assignmentsByEvent, setAssignmentsByEvent] = useState({});
				const [targetTrim, setTargetTrim] = useState(0);

				// Locked & Selection State
				const [lockedSeats, setLockedSeats] = useState([]);
				const [selectedPaddlerId, setSelectedPaddlerId] = useState(null);
				const [isSimulating, setIsSimulating] = useState(false);
				const [confirmClear, setConfirmClear] = useState(false);

				// Forms
				const [paddlerFormName, setPaddlerFormName] = useState('');
				const [paddlerFormWeight, setPaddlerFormWeight] = useState('');
				const [paddlerFormSkills, setPaddlerFormSkills] = useState({
					left: false,
					right: false,
					drum: false,
					steer: false,
				});
				const [editingPaddlerId, setEditingPaddlerId] = useState(null);
				const [newEventTitle, setNewEventTitle] = useState('');
				const [newEventDate, setNewEventDate] = useState('');

				useEffect(() => {
					const data = db.load();
					if (data) {
						setPaddlers(data.paddlers || []);
						setEvents(data.events || []);
						setAssignmentsByEvent(data.assignmentsByEvent || {});
						if (data.darkMode !== undefined) setIsDarkMode(data.darkMode);
						if (data.targetTrim !== undefined)
							setTargetTrim(data.targetTrim);
					} else {
						seedInitialData();
					}
					setIsLoading(false);

					const hasSeenOnboarding = localStorage.getItem(
						'drachenboot_onboarding_seen'
					);
					if (!hasSeenOnboarding) setShowOnboarding(true);
					if (
						!data &&
						window.matchMedia &&
						window.matchMedia('(prefers-color-scheme: dark)').matches
					)
						setIsDarkMode(true);
				}, []);

				useEffect(() => {
					if (!isLoading)
						db.save({
							paddlers,
							events,
							assignmentsByEvent,
							darkMode: isDarkMode,
							targetTrim,
						});
					if (isDarkMode) document.documentElement.classList.add('dark');
					else document.documentElement.classList.remove('dark');
				}, [
					paddlers,
					events,
					assignmentsByEvent,
					isDarkMode,
					targetTrim,
					isLoading,
				]);

				const toggleDarkMode = () => setIsDarkMode(!isDarkMode);
				const closeOnboarding = () => {
					localStorage.setItem('drachenboot_onboarding_seen', 'true');
					setShowOnboarding(false);
				};

				const seedInitialData = () => {
					const initialPaddlers = [
						{ id: 1, name: 'Alex', weight: 85, skills: ['left', 'right'] },
						{
							id: 2,
							name: 'Anna',
							weight: 55,
							skills: ['drum', 'left', 'right'],
						},
						{ id: 3, name: 'Christopher', weight: 82, skills: ['left'] },
						{
							id: 4,
							name: 'David',
							weight: 95,
							skills: ['left', 'right', 'steer'],
						},
						{ id: 5, name: 'Jana', weight: 54, skills: ['left'] },
						{
							id: 6,
							name: 'Julia',
							weight: 58,
							skills: ['drum', 'right'],
						},
						{ id: 7, name: 'Lisa', weight: 62, skills: ['left'] },
						{ id: 8, name: 'Maria', weight: 63, skills: ['right'] },
						{ id: 9, name: 'Michael', weight: 92, skills: ['right'] },
						{ id: 10, name: 'Nina', weight: 60, skills: ['right'] },
						{ id: 11, name: 'Robert', weight: 89, skills: ['left'] },
						{ id: 12, name: 'Sarah', weight: 65, skills: ['left'] },
						{ id: 13, name: 'Sophie', weight: 59, skills: ['right'] },
						{
							id: 14,
							name: 'Stefan',
							weight: 98,
							skills: ['right', 'steer'],
						},
						{ id: 15, name: 'Thomas', weight: 88, skills: ['right'] },
						{ id: 16, name: 'Maximilian', weight: 78, skills: ['left'] },
					];
					setPaddlers(initialPaddlers);
					const initEventId = Date.now();
					setEvents([
						{
							id: initEventId,
							title: 'Erstes Training',
							date: new Date().toISOString().split('T')[0],
							type: 'training',
							attendance: initialPaddlers.reduce(
								(acc, p) => ({ ...acc, [p.id]: 'yes' }),
								{}
							),
						},
					]);
					setAssignmentsByEvent({ [initEventId]: {} });
				};

				const currentContextId = activeEventId || 'global';
				const assignments = useMemo(
					() => assignmentsByEvent[currentContextId] || {},
					[assignmentsByEvent, currentContextId]
				);
				const updateAssignments = useCallback(
					(newAssignments) => {
						setAssignmentsByEvent((prev) => ({
							...prev,
							[currentContextId]: newAssignments,
						}));
					},
					[currentContextId]
				);

				const activeEvent = useMemo(
					() => events.find((e) => e.id === activeEventId),
					[activeEventId, events]
				);
				const activeEventTitle = activeEvent
					? activeEvent.title
					: 'Sandbox';
				const activePaddlerPool = useMemo(() => {
					let pool = paddlers;
					if (activeEventId && activeEvent) {
						pool = paddlers.filter((p) =>
							['yes', 'maybe'].includes(activeEvent.attendance[p.id])
						);
					}
					return [...pool].sort((a, b) => a.name.localeCompare(b.name));
				}, [paddlers, activeEventId, activeEvent]);

				// --- ACTIONS ---
				const toggleSkill = (skill) => {
					setPaddlerFormSkills((prev) => ({
						...prev,
						[skill]: !prev[skill],
					}));
				};

				const resetPaddlerForm = () => {
					setEditingPaddlerId(null);
					setPaddlerFormName('');
					setPaddlerFormWeight('');
					setPaddlerFormSkills({
						left: false,
						right: false,
						drum: false,
						steer: false,
					});
				};

				const handleSavePaddler = (e) => {
					e.preventDefault();
					if (!paddlerFormName || !paddlerFormWeight) return;
					const skillsArray = Object.keys(paddlerFormSkills).filter(
						(k) => paddlerFormSkills[k]
					);
					if (skillsArray.length === 0) {
						alert('Bitte eine Rolle w√§hlen.');
						return;
					}
					const pData = {
						name: paddlerFormName,
						weight: parseFloat(paddlerFormWeight),
						skills: skillsArray,
					};
					if (editingPaddlerId) {
						setPaddlers((prev) =>
							prev.map((p) =>
								p.id === editingPaddlerId ? { ...p, ...pData } : p
							)
						);
						setEditingPaddlerId(null);
					} else {
						setPaddlers((prev) => [...prev, { id: Date.now(), ...pData }]);
					}
					resetPaddlerForm();
				};

				const handleEditPaddler = (p) => {
					setEditingPaddlerId(p.id);
					setPaddlerFormName(p.name);
					setPaddlerFormWeight(p.weight);
					const sObj = {
						left: false,
						right: false,
						drum: false,
						steer: false,
					};
					if (p.skills) p.skills.forEach((s) => (sObj[s] = true));
					setPaddlerFormSkills(sObj);
					window.scrollTo({ top: 0, behavior: 'smooth' });
				};

				const triggerDelete = (id) => {
					if (deleteConfirmId === id) {
						handleDeletePaddler(id);
						setDeleteConfirmId(null);
					} else {
						setDeleteConfirmId(id);
						setTimeout(() => setDeleteConfirmId(null), 3000);
					}
				};

				const handleDeletePaddler = (id) => {
					setAssignmentsByEvent((prev) => {
						const next = { ...prev };
						Object.keys(next).forEach((eid) => {
							const map = { ...next[eid] };
							let chg = false;
							Object.keys(map).forEach((s) => {
								if (map[s] === id) {
									delete map[s];
									chg = true;
								}
							});
							if (chg) next[eid] = map;
						});
						return next;
					});
					setEvents((prev) =>
						prev.map((ev) => {
							const att = { ...ev.attendance };
							delete att[id];
							return { ...ev, attendance: att };
						})
					);
					setPaddlers((prev) => prev.filter((p) => p.id !== id));
					if (editingPaddlerId === id) resetPaddlerForm();
				};

				const handleCreateEvent = (e) => {
					e.preventDefault();
					if (!newEventTitle || !newEventDate) return;
					const nid = Date.now();
					const ne = {
						id: nid,
						title: newEventTitle,
						date: newEventDate,
						type: 'training',
						attendance: {},
					};
					setEvents((prev) => [...prev, ne]);
					setAssignmentsByEvent((prev) => ({ ...prev, [nid]: {} }));
					setNewEventTitle('');
					setNewEventDate('');
				};

				const updateAttendance = (eid, pid, status) => {
					setEvents((prev) =>
						prev.map((ev) => {
							if (ev.id !== eid) return ev;
							return {
								...ev,
								attendance: { ...ev.attendance, [pid]: status },
							};
						})
					);
				};
				const handlePlanEvent = (eid) => {
					setActiveEventId(eid);
					setView('planner');
					setLockedSeats([]);
					setSelectedPaddlerId(null);
					if (!assignmentsByEvent[eid])
						setAssignmentsByEvent((prev) => ({ ...prev, [eid]: {} }));
				};
				const goHome = () => {
					setActiveEventId(null);
					setView('team');
				};
				const handleExportImage = () => {
					if (!boatRef.current || !window.html2canvas) return;
					setIsExporting(true);
					setTimeout(() => {
						window
							.html2canvas(boatRef.current, {
								backgroundColor: null,
								scale: 3,
								useCORS: true,
							})
							.then((canvas) => {
								const link = document.createElement('a');
								link.download = `drachenboot-${activeEventTitle.replace(
									/\s+/g,
									'-'
								)}.png`;
								link.href = canvas.toDataURL();
								link.click();
								setIsExporting(false);
							})
							.catch((err) => {
								console.error('Export failed', err);
								setIsExporting(false);
							});
					}, 150);
				};

				// --- BOAT ---
				const rows = 10;
				const boatConfig = useMemo(() => {
					const s = [];
					s.push({ id: 'drummer', type: 'drummer' });
					for (let i = 1; i <= rows; i++) {
						s.push({
							id: `row-${i}-left`,
							type: 'paddler',
							side: 'left',
							row: i,
						});
						s.push({
							id: `row-${i}-right`,
							type: 'paddler',
							side: 'right',
							row: i,
						});
					}
					s.push({ id: 'steer', type: 'steer' });
					return s;
				}, []);
				const stats = useMemo(() => {
					let l = 0,
						r = 0,
						t = 0,
						f = 0,
						b = 0,
						c = 0;
					Object.entries(assignments).forEach(([sid, pid]) => {
						const p = paddlers.find((x) => x.id === pid);
						if (!p) return;
						t += p.weight;
						c++;
						if (sid.includes('row')) {
							if (sid.includes('left')) l += p.weight;
							else r += p.weight;
							const rw = parseInt(sid.match(/row-(\d+)/)[1]);
							if (rw <= 5) f += p.weight;
							else b += p.weight;
						}
					});
					return { l, r, t, diffLR: l - r, f, b, diffFB: f - b, c };
				}, [assignments, paddlers]);
				const cgStats = useMemo(() => {
					let totalWeight = 0;
					let weightedSumX = 0;
					let weightedSumY = 0;
					Object.entries(assignments).forEach(([sid, pid]) => {
						const p = paddlers.find((x) => x.id === pid);
						if (!p) return;
						totalWeight += p.weight;
						let xPos = 50;
						if (sid.includes('left')) xPos = 25;
						else if (sid.includes('right')) xPos = 75;
						let yPos = 50;
						if (sid === 'drummer') yPos = 4;
						else if (sid === 'steer') yPos = 96;
						else if (sid.includes('row')) {
							const r = parseInt(sid.match(/row-(\d+)/)[1]);
							yPos = 12 + ((r - 1) / 9) * 70;
						}
						weightedSumX += p.weight * xPos;
						weightedSumY += p.weight * yPos;
					});
					const cgX = totalWeight > 0 ? weightedSumX / totalWeight : 50;
					const cgY = totalWeight > 0 ? weightedSumY / totalWeight : 50;
					const targetY = 50 - targetTrim * 0.1;
					return { x: cgX, y: cgY, targetY };
				}, [assignments, paddlers, targetTrim]);

				const handleSeatClick = (sid) => {
					if (lockedSeats.includes(sid)) return;
					if (selectedPaddlerId) {
						const nAss = { ...assignments };
						Object.keys(nAss).forEach((k) => {
							if (nAss[k] === selectedPaddlerId) delete nAss[k];
						});
						nAss[sid] = selectedPaddlerId;
						updateAssignments(nAss);
						setSelectedPaddlerId(null);
					} else if (assignments[sid]) {
						setSelectedPaddlerId(assignments[sid]);
					}
				};
				const handleUnassign = (sid, e) => {
					e.stopPropagation();
					if (lockedSeats.includes(sid)) return;
					const nAss = { ...assignments };
					delete nAss[sid];
					updateAssignments(nAss);
				};
				const toggleLock = (sid, e) => {
					e.stopPropagation();
					if (!assignments[sid]) return;
					setLockedSeats((prev) =>
						prev.includes(sid)
							? prev.filter((i) => i !== sid)
							: [...prev, sid]
					);
				};
				const clearBoat = () => {
					if (confirmClear) {
						const nAss = { ...assignments };
						Object.keys(nAss).forEach((s) => {
							if (!lockedSeats.includes(s)) delete nAss[s];
						});
						updateAssignments(nAss);
						setConfirmClear(false);
					} else {
						setConfirmClear(true);
						setTimeout(() => setConfirmClear(false), 3000);
					}
				};
				const runAutoFill = () => {
					setIsSimulating(true);
					setTimeout(() => {
						const lockedAss = {};
						lockedSeats.forEach((s) => {
							if (assignments[s]) lockedAss[s] = assignments[s];
						});
						const lockedIds = Object.values(lockedAss);
						let pool = activePaddlerPool.filter(
							(p) => !lockedIds.includes(p.id)
						);
						if (pool.length === 0) {
							setIsSimulating(false);
							return;
						}
						let bestAss = null,
							bestScore = -Infinity;
						for (let i = 0; i < 1500; i++) {
							let currAss = { ...lockedAss };
							let currPool = [...pool].sort(() => Math.random() - 0.5);
							if (!currAss['steer']) {
								const steers = currPool.filter(
									(p) => p.skills && p.skills.includes('steer')
								);
								if (steers.length) {
									const p = steers[0];
									currAss['steer'] = p.id;
									currPool = currPool.filter((x) => x.id !== p.id);
								}
							}
							const sortedW = [...currPool].sort(
								(a, b) => a.weight - b.weight
							);
							const light = sortedW.slice(
								0,
								Math.max(2, Math.floor(currPool.length * 0.3))
							);
							['row-1-left', 'row-1-right'].forEach((sid) => {
								if (currAss[sid] || currPool.length === 0) return;
								const side = sid.includes('left') ? 'left' : 'right';
								const cands = light.filter(
									(p) =>
										currPool.includes(p) &&
										p.skills &&
										p.skills.includes(side)
								);
								if (cands.length) {
									const p =
										cands[Math.floor(Math.random() * cands.length)];
									currAss[sid] = p.id;
									currPool = currPool.filter((x) => x.id !== p.id);
								}
							});
							currPool.sort(
								(a, b) =>
									b.weight +
									Math.random() * 5 -
									(a.weight + Math.random() * 5)
							);
							const free = [];
							for (let r = 1; r <= rows; r++) {
								if (!currAss[`row-${r}-left`])
									free.push({ id: `row-${r}-left`, side: 'left', r });
								if (!currAss[`row-${r}-right`])
									free.push({ id: `row-${r}-right`, side: 'right', r });
							}
							for (let p of currPool) {
								if (p.skills.length === 1 && p.skills[0] === 'drum')
									continue;
								let l = 0,
									r = 0,
									f = 0,
									b = 0;
								Object.entries(currAss).forEach(([sid, pid]) => {
									if (sid === 'drummer' || sid === 'steer') return;
									const pad = paddlers.find((x) => x.id === pid);
									if (!pad) return;
									if (sid.includes('left')) l += pad.weight;
									else r += pad.weight;
									if (parseInt(sid.match(/row-(\d+)/)[1]) <= 5)
										f += pad.weight;
									else b += pad.weight;
								});
								const nLeft = l <= r,
									nBack = f - b > targetTrim;
								const valid = free.filter(
									(s) => p.skills && p.skills.includes(s.side)
								);
								if (valid.length) {
									valid.sort((A, B) => {
										let sa = 0,
											sb = 0;
										if (l <= r && A.side === 'left') sa += 50;
										else if (l > r && A.side === 'right') sa += 50;
										if (l <= r && B.side === 'left') sb += 50;
										else if (l > r && B.side === 'right') sb += 50;
										const oA = A.side === 'left' ? 'right' : 'left';
										const oB = B.side === 'left' ? 'right' : 'left';
										if (currAss[`row-${A.r}-${oA}`]) sa += 80;
										if (currAss[`row-${B.r}-${oB}`]) sb += 80;
										if (nBack) {
											sa += A.r * 3;
											sb += B.r * 3;
										} else {
											sa += (11 - A.r) * 3;
											sb += (11 - B.r) * 3;
										}
										return sb - sa;
									});
									const best = valid[0];
									currAss[best.id] = p.id;
									free.splice(
										free.findIndex((x) => x.id === best.id),
										1
									);
								}
							}
							const assignedIds = Object.values(currAss);
							let remainingForDrum = pool.filter(
								(p) => !assignedIds.includes(p.id)
							);
							if (!currAss['drummer'] && remainingForDrum.length > 0) {
								const drummers = remainingForDrum.filter(
									(p) => p.skills && p.skills.includes('drum')
								);
								if (drummers.length) {
									const p = drummers[0];
									currAss['drummer'] = p.id;
								}
							}
							let fl = 0,
								fr = 0,
								ff = 0,
								fb = 0,
								full = 0;
							for (let r = 1; r <= rows; r++) {
								if (currAss[`row-${r}-left`] && currAss[`row-${r}-right`])
									full++;
							}
							Object.entries(currAss).forEach(([sid, pid]) => {
								if (sid === 'drummer' || sid === 'steer') return;
								const pad = paddlers.find((x) => x.id === pid);
								if (!pad) return;
								if (sid.includes('left')) fl += pad.weight;
								else fr += pad.weight;
								if (parseInt(sid.match(/row-(\d+)/)[1]) <= 5)
									ff += pad.weight;
								else fb += pad.weight;
							});
							let sc = -Math.pow(Math.abs(fl - fr), 2);
							const trim = ff - fb;
							const dist = Math.abs(trim - targetTrim);
							sc -= dist * 8;
							sc += full * 80;
							if (currAss['drummer']) sc += 200;
							if (currAss['steer']) sc += 200;
							if (sc > bestScore) {
								bestScore = sc;
								bestAss = currAss;
							}
						}
						updateAssignments(bestAss);
						setIsSimulating(false);
					}, 50);
				};

				// --- RENDER ---
				if (view === 'team') {
					const sortedPaddlers = [...paddlers].sort((a, b) =>
						a.name.localeCompare(b.name)
					);
					return (
						<div className="min-h-screen bg-slate-100 p-2 md:p-4 font-sans text-slate-800 pb-20 dark:bg-slate-950 dark:text-slate-100 transition-colors">
							{showHelp && (
								<HelpModal onClose={() => setShowHelp(false)} />
							)}
							{showImprint && (
								<ImprintModal onClose={() => setShowImprint(false)} />
							)}
							{showOnboarding && (
								<OnboardingModal onClose={closeOnboarding} />
							)}

							<div className="max-w-6xl mx-auto">
								<header className="mb-6 flex justify-between items-center bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 sticky top-0 z-30">
									<div className="flex items-center gap-3">
										<DragonLogo className="w-10 h-10 text-blue-600 dark:text-blue-400" />
										<div>
											<h1 className="text-xl font-bold text-slate-900 dark:text-white leading-none">
												Team Manager
											</h1>
											<p className="text-xs text-slate-500 dark:text-slate-400">
												Kader & Termine
											</p>
										</div>
									</div>
									<div className="flex gap-2">
										<button
											onClick={() => setShowHelp(true)}
											className="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400"
										>
											<Info size={20} />
										</button>
										<button
											onClick={toggleDarkMode}
											className="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400"
										>
											{isDarkMode ? <Sun size={20} /> : <Moon size={20} />}
										</button>
										<button
											onClick={() => setView('planner')}
											className="px-4 py-2 bg-white dark:bg-slate-800 text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-slate-700 rounded-lg font-medium flex items-center gap-2"
										>
											<ArrowLeft size={16} /> Zum Boots-Planer
										</button>
									</div>
								</header>

								<div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
									<div className="lg:col-span-1 space-y-4">
										<div className="bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800">
											<h3 className="font-bold text-slate-700 dark:text-slate-200 mb-3 flex items-center gap-2 text-sm uppercase tracking-wide">
												<Calendar size={16} /> Neuer Termin
											</h3>
											<form
												onSubmit={handleCreateEvent}
												className="space-y-2"
											>
												<input
													className="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-sm dark:text-white"
													placeholder="Titel"
													value={newEventTitle}
													onChange={(e) =>
														setNewEventTitle(e.target.value)
													}
												/>
												<input
													type="date"
													className="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-sm dark:text-white"
													value={newEventDate}
													onChange={(e) => setNewEventDate(e.target.value)}
												/>
												<button
													type="submit"
													className="w-full bg-blue-600 text-white p-2 rounded text-sm font-medium hover:bg-blue-700"
												>
													+ Erstellen
												</button>
											</form>
										</div>
										<div className="space-y-4">
											{events
												.sort(
													(a, b) => new Date(a.date) - new Date(b.date)
												)
												.map((evt) => {
													const yesCount = Object.values(
														evt.attendance
													).filter((s) => s === 'yes').length;
													return (
														<div
															key={evt.id}
															className="bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 hover:shadow-md transition-shadow"
														>
															<div className="flex justify-between items-start mb-2">
																<div>
																	<div className="font-bold text-slate-800 dark:text-white text-lg">
																		{evt.title}
																	</div>
																	<div className="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-1">
																		<Calendar size={14} />{' '}
																		{new Date(evt.date).toLocaleDateString(
																			'de-DE'
																		)}
																	</div>
																</div>
																<div
																	className={`text-[10px] px-2 py-1 rounded-full font-bold uppercase ${
																		evt.type === 'race'
																			? 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-200'
																			: 'bg-blue-50 dark:bg-blue-900 text-blue-600 dark:text-blue-200'
																	}`}
																>
																	{evt.type === 'race'
																		? 'Regatta'
																		: 'Training'}
																</div>
															</div>
															<div className="flex justify-between items-center mt-4 pb-4 border-b border-slate-100 dark:border-slate-800">
																<div className="text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-lg">
																	<span className="text-green-600 dark:text-green-400 font-bold">
																		{yesCount}
																	</span>{' '}
																	Zusagen
																</div>
																<button
																	onClick={() => handlePlanEvent(evt.id)}
																	className="text-sm bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-1"
																>
																	Planen <ChevronRight size={16} />
																</button>
															</div>
															<div className="mt-2 max-h-60 overflow-y-auto space-y-1 pt-2">
																{sortedPaddlers.map((p) => {
																	const status = evt.attendance[p.id];
																	return (
																		<div
																			key={p.id}
																			className="flex justify-between items-center py-1 text-sm border-b border-slate-50 dark:border-slate-800 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-800 px-1 rounded"
																		>
																			<span
																				className={`font-medium ${
																					status === 'no'
																						? 'text-slate-400 dark:text-slate-600 line-through'
																						: 'text-slate-700 dark:text-slate-200'
																				}`}
																			>
																				{p.name}
																			</span>
																			<div className="flex gap-1">
																				<button
																					onClick={() =>
																						updateAttendance(
																							evt.id,
																							p.id,
																							'yes'
																						)
																					}
																					className={`w-8 h-8 flex items-center justify-center rounded-lg border transition-all ${
																						status === 'yes'
																							? 'bg-green-500 text-white border-green-600'
																							: 'bg-white dark:bg-slate-800 text-slate-300 dark:text-slate-600 border-slate-200 dark:border-slate-700 hover:border-slate-300'
																					}`}
																					title="Zusage"
																				>
																					<Check size={16} />
																				</button>
																				<button
																					onClick={() =>
																						updateAttendance(
																							evt.id,
																							p.id,
																							'maybe'
																						)
																					}
																					className={`w-8 h-8 flex items-center justify-center rounded-lg border transition-all ${
																						status === 'maybe'
																							? 'bg-yellow-400 text-white border-yellow-500'
																							: 'bg-white dark:bg-slate-800 text-slate-300 dark:text-slate-600 border-slate-200 dark:border-slate-700 hover:border-slate-300'
																					}`}
																					title="Vielleicht"
																				>
																					<HelpCircle size={16} />
																				</button>
																				<button
																					onClick={() =>
																						updateAttendance(
																							evt.id,
																							p.id,
																							'no'
																						)
																					}
																					className={`w-8 h-8 flex items-center justify-center rounded-lg border transition-all ${
																						status === 'no'
																							? 'bg-red-500 text-white border-red-600'
																							: 'bg-white dark:bg-slate-800 text-slate-300 dark:text-slate-600 border-slate-200 dark:border-slate-700 hover:border-slate-300'
																					}`}
																					title="Absage"
																				>
																					<X size={16} />
																				</button>
																			</div>
																		</div>
																	);
																})}
															</div>
														</div>
													);
												})}
										</div>
									</div>

									<div className="lg:col-span-2 space-y-6">
										<div
											className={`p-6 rounded-xl shadow-sm border transition-all ${
												editingPaddlerId
													? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800 ring-1 ring-orange-200 dark:ring-orange-900'
													: 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800'
											}`}
										>
											<h3
												className={`font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wide ${
													editingPaddlerId
														? 'text-orange-800 dark:text-orange-200'
														: 'text-slate-700 dark:text-slate-200'
												}`}
											>
												{editingPaddlerId ? (
													<Pencil size={16} />
												) : (
													<User size={16} />
												)}{' '}
												{editingPaddlerId
													? 'Paddler bearbeiten'
													: 'Neues Mitglied'}
											</h3>
											<form
												onSubmit={handleSavePaddler}
												className="space-y-4"
											>
												<div className="flex flex-col md:flex-row gap-4">
													<div className="flex-1">
														<label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">
															Name
														</label>
														<input
															className="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-sm outline-none dark:text-white"
															value={paddlerFormName}
															onChange={(e) =>
																setPaddlerFormName(e.target.value)
															}
															placeholder="Name"
														/>
													</div>
													<div className="w-full md:w-32">
														<label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">
															Gewicht
														</label>
														<input
															type="number"
															className="w-full p-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-sm outline-none dark:text-white"
															value={paddlerFormWeight}
															onChange={(e) =>
																setPaddlerFormWeight(e.target.value)
															}
															placeholder="kg"
														/>
													</div>
												</div>
												<div>
													<label className="text-[10px] uppercase font-bold text-slate-400 mb-2 block">
														Skills
													</label>
													<div className="flex gap-2 flex-wrap">
														<button
															type="button"
															onClick={() => toggleSkill('left')}
															className={`px-3 py-1.5 rounded-lg border text-sm font-medium transition-all ${
																paddlerFormSkills.left
																	? 'bg-red-500 border-red-600 text-white'
																	: 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400'
															}`}
														>
															Links
														</button>
														<button
															type="button"
															onClick={() => toggleSkill('right')}
															className={`px-3 py-1.5 rounded-lg border text-sm font-medium transition-all ${
																paddlerFormSkills.right
																	? 'bg-green-500 border-green-600 text-white'
																	: 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400'
															}`}
														>
															Rechts
														</button>
														<button
															type="button"
															onClick={() => toggleSkill('drum')}
															className={`px-3 py-1.5 rounded-lg border text-sm font-medium transition-all flex items-center gap-1 ${
																paddlerFormSkills.drum
																	? 'bg-yellow-400 border-yellow-500 text-yellow-900'
																	: 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400'
															}`}
														>
															<Drum size={12} /> Trommel
														</button>
														<button
															type="button"
															onClick={() => toggleSkill('steer')}
															className={`px-3 py-1.5 rounded-lg border text-sm font-medium transition-all flex items-center gap-1 ${
																paddlerFormSkills.steer
																	? 'bg-purple-500 border-purple-600 text-white'
																	: 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400'
															}`}
														>
															<ShipWheel size={12} /> Steuer
														</button>
													</div>
												</div>
												<div className="flex gap-2 pt-2">
													{editingPaddlerId && (
														<button
															type="button"
															onClick={resetPaddlerForm}
															className="bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded text-sm"
														>
															Abbruch
														</button>
													)}
													<button
														type="submit"
														className={`text-white px-6 py-2 rounded text-sm font-medium flex items-center gap-2 shadow-sm active:scale-95 transition-all ${
															editingPaddlerId
																? 'bg-orange-500 hover:bg-orange-600'
																: 'bg-blue-600 hover:bg-blue-700'
														}`}
													>
														{editingPaddlerId ? (
															<Save size={16} />
														) : (
															<Plus size={16} />
														)}{' '}
														{editingPaddlerId ? 'Speichern' : 'Hinzuf√ºgen'}
													</button>
												</div>
											</form>
										</div>
										<div className="bg-white dark:bg-slate-900 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800">
											<h3 className="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
												<Users size={16} /> Kader ({paddlers.length})
											</h3>
											<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
												{sortedPaddlers.map((p) => (
													<div
														key={p.id}
														className={`p-3 border rounded-xl transition-all relative group ${
															editingPaddlerId === p.id
																? 'border-orange-400 bg-orange-50 dark:bg-orange-900/20'
																: 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:bg-white dark:hover:bg-slate-750'
														}`}
													>
														<div className="flex justify-between items-start">
															<div>
																<div className="font-bold text-slate-800 dark:text-slate-200">
																	{p.name}
																</div>
																<div className="text-xs text-slate-500 dark:text-slate-400 mt-1 font-mono">
																	{p.weight} kg
																</div>
															</div>
															<div className="flex gap-1 items-center justify-center">
																{p.skills?.includes('left') && (
																	<span className="w-5 h-4 flex items-center justify-center rounded border text-[9px] font-bold bg-red-50 text-red-600 border-red-100 dark:bg-red-900/50 dark:text-red-300 dark:border-red-800">
																		L
																	</span>
																)}
																{p.skills?.includes('right') && (
																	<span className="w-5 h-4 flex items-center justify-center rounded border text-[9px] font-bold bg-green-50 text-green-600 border-green-100 dark:bg-green-900/50 dark:text-green-300 dark:border-green-800">
																		R
																	</span>
																)}
																{p.skills?.includes('drum') && (
																	<span className="w-5 h-4 flex items-center justify-center rounded border text-[9px] font-bold bg-yellow-50 text-yellow-600 border-yellow-100 dark:bg-yellow-900/50 dark:text-yellow-300 dark:border-yellow-800">
																		<Drum size={10} />
																	</span>
																)}
																{p.skills?.includes('steer') && (
																	<span className="w-5 h-4 flex items-center justify-center rounded border text-[9px] font-bold bg-purple-50 text-purple-600 border-purple-100 dark:bg-purple-900/50 dark:text-purple-300 dark:border-purple-800">
																		<ShipWheel size={10} />
																	</span>
																)}
															</div>
														</div>
														<div className="absolute bottom-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
															<button
																onClick={() => handleEditPaddler(p)}
																className="bg-white dark:bg-slate-700 text-slate-400 hover:text-orange-500 p-1.5 rounded-lg border dark:border-slate-600 shadow-sm"
															>
																<Pencil size={12} />
															</button>
															<button
																onClick={() => triggerDelete(p.id)}
																className={`p-1.5 rounded-lg border shadow-sm transition-colors ${
																	deleteConfirmId === p.id
																		? 'bg-red-600 text-white border-red-700'
																		: 'bg-white dark:bg-slate-700 text-slate-400 hover:text-red-500 dark:border-slate-600'
																}`}
															>
																<Trash2 size={12} />
															</button>
														</div>
													</div>
												))}
											</div>
										</div>
									</div>
								</div>
								<footer className="mt-20 pb-10 text-center text-xs text-slate-400">
									<button
										onClick={() => setShowImprint(true)}
										className="hover:text-slate-600 dark:hover:text-slate-300 underline underline-offset-2 decoration-slate-300 dark:decoration-slate-600"
									>
										Impressum
									</button>
								</footer>
							</div>
						</div>
					);
				}

				// === PLANNER VIEW ===
				return (
					<div
						className={`min-h-screen font-sans text-slate-800 dark:text-slate-100 transition-colors duration-300 bg-slate-100 dark:bg-slate-950 p-2 md:p-4 pb-20`}
					>
						{showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
						<div className="max-w-6xl mx-auto">
							<header className="mb-4 flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white dark:bg-slate-900 p-3 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 sticky top-0 z-30">
								<div>
									<div className="flex items-center gap-3">
										<button
											onClick={goHome}
											className="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-500 hover:text-blue-600 hover:border-blue-300 transition-colors"
										>
											<Home size={20} />
										</button>
										<div className="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
										<div>
											<div className="flex items-center gap-2">
												<Calendar size={14} className="text-blue-500" />
												<span className="font-bold text-slate-800 dark:text-white text-sm">
													{activeEventTitle}
												</span>
											</div>
											<p className="text-[10px] text-slate-400 uppercase tracking-wider font-bold">
												Planungsmodus
											</p>
										</div>
									</div>
								</div>
								<div className="flex gap-2 items-center">
									<div className="text-center px-2">
										<div className="text-[10px] text-slate-400 uppercase font-bold">
											Gesamt
										</div>
										<div className="font-bold text-sm">{stats.t} kg</div>
									</div>
									<div className="w-px h-8 bg-slate-100 dark:bg-slate-800"></div>
									<div className="text-center px-2">
										<div className="text-[10px] text-slate-400 uppercase font-bold">
											Besetzt
										</div>
										<div className="font-bold text-sm text-blue-600 dark:text-blue-400">
											{stats.c} / 22
										</div>
									</div>
									<div className="w-px h-8 bg-slate-100 dark:bg-slate-800 mx-2"></div>
									<button
										onClick={() => setShowHelp(true)}
										className="p-2 rounded-lg bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-blue-50 dark:hover:bg-slate-700"
									>
										<Info size={18} />
									</button>
									<button
										onClick={toggleDarkMode}
										className="p-2 rounded-lg bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-blue-50 dark:hover:bg-slate-700"
									>
										{isDarkMode ? <Sun size={18} /> : <Moon size={18} />}
									</button>
								</div>
							</header>

							<div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
								<div className="lg:col-span-1 space-y-4">
									<div className="bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800">
										<h2 className="font-bold text-sm text-slate-700 dark:text-slate-200 uppercase tracking-wide mb-3 flex items-center gap-2">
											<ArrowRightLeft size={16} /> Balance & Schwerpunkt
										</h2>
										<div className="w-full mb-3">
											<div className="flex justify-between text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1">
												<span>Links</span>{' '}
												<span>Diff: {Math.abs(stats.diffLR)}</span>{' '}
												<span>Rechts</span>
											</div>
											<div className="h-3 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden flex relative">
												<div
													className={`h-full transition-all duration-500 ${
														Math.abs(stats.diffLR) > 20
															? 'bg-red-500'
															: Math.abs(stats.diffLR) > 10
															? 'bg-yellow-400'
															: 'bg-green-500'
													}`}
													style={{
														width: `${
															(stats.l / (stats.l + stats.r || 1)) * 100
														}%`,
													}}
												></div>
												<div className="absolute left-1/2 top-0 bottom-0 w-px bg-slate-300 transform -translate-x-1/2"></div>
											</div>
										</div>
										<div className="w-full p-3 bg-blue-50/50 dark:bg-blue-900/30 rounded-lg border border-blue-100 dark:border-blue-800">
											<div className="flex justify-between text-xs text-blue-800 dark:text-blue-300 font-bold mb-1">
												<span className="flex gap-1">
													<ArrowUpFromLine size={12} /> Bug: {stats.f}
												</span>
												<span className="flex gap-1">
													<Anchor size={12} /> Heck: {stats.b}
												</span>
											</div>
											<div className="text-[10px] uppercase font-bold text-center pt-1 text-blue-400 flex justify-between">
												<span>
													{stats.diffFB > 0
														? `Buglastig`
														: stats.diffFB < 0
														? `Hecklastig`
														: 'Perfekt'}
												</span>
												<span
													className={
														stats.diffFB > 0
															? 'text-red-400'
															: 'text-green-500'
													}
												>
													{stats.diffFB > 0 ? '+' : ''}
													{stats.diffFB}
												</span>
											</div>
										</div>
										<div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
											<div className="flex justify-between text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">
												<span>Hecklastig</span>
												<span className="text-blue-600 dark:text-blue-400">
													Ziel: {targetTrim > 0 ? '+' : ''}
													{targetTrim} kg
												</span>
												<span>Buglastig</span>
											</div>
											<input
												type="range"
												min="-100"
												max="100"
												step="5"
												value={targetTrim}
												onChange={(e) =>
													setTargetTrim(parseInt(e.target.value))
												}
												className="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-600"
											/>
											<div className="flex justify-between text-[10px] text-slate-400 mt-1">
												<span>-100kg</span>
												<span>0</span>
												<span>+100kg</span>
											</div>
										</div>
										<div className="grid grid-cols-3 gap-2 mt-4">
											<button
												onClick={runAutoFill}
												disabled={
													isSimulating || activePaddlerPool.length === 0
												}
												className={`py-3 text-sm font-semibold rounded-lg border dark:border-slate-700 transition-all flex items-center justify-center gap-2 shadow-sm ${
													isSimulating
														? 'bg-indigo-50 text-indigo-400 cursor-wait'
														: 'bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95'
												} ${
													activePaddlerPool.length === 0
														? 'opacity-50 cursor-not-allowed'
														: ''
												}`}
											>
												{isSimulating ? (
													<RefreshCw size={16} className="animate-spin" />
												) : (
													<Wand2 size={16} />
												)}
											</button>
											<button
												onClick={handleExportImage}
												className="py-3 text-sm rounded-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center gap-2"
												title="Bild speichern"
											>
												<Camera size={16} />
											</button>
											<button
												onClick={clearBoat}
												className={`py-3 text-sm rounded-lg border dark:border-slate-700 transition-all flex items-center justify-center gap-2 active:scale-95 ${
													confirmClear
														? 'bg-red-500 text-white border-red-600 font-bold'
														: 'text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 border-red-200'
												}`}
											>
												{confirmClear ? (
													<AlertCircle size={16} />
												) : (
													<RotateCcw size={16} />
												)}
											</button>
										</div>
									</div>
									<div className="bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 h-[600px] flex flex-col">
										<h2 className="font-bold text-sm text-slate-700 dark:text-slate-200 uppercase tracking-wide mb-3 flex items-center gap-2">
											<User size={16} /> Verf√ºgbar (
											{activePaddlerPool.length})
										</h2>
										{activePaddlerPool.length === 0 && (
											<div className="text-center p-8 text-slate-400 italic text-sm border-2 border-dashed border-slate-100 dark:border-slate-800 rounded-xl">
												Keine Zusagen.
											</div>
										)}
										<div className="flex-1 overflow-y-auto pr-1 space-y-2">
											{activePaddlerPool.map((p) => {
												const isAssigned = Object.values(
													assignments
												).includes(p.id);
												const isSelected = selectedPaddlerId === p.id;
												const st = activeEvent
													? activeEvent.attendance[p.id]
													: null;
												const isMaybe = st === 'maybe';
												return (
													<div
														key={p.id}
														onClick={() =>
															setSelectedPaddlerId(
																isSelected ? null : p.id
															)
														}
														className={`p-3 rounded-xl border cursor-pointer transition-all flex justify-between items-center group ${
															isSelected
																? 'bg-blue-600 border-blue-700 text-white shadow-md transform scale-[1.02]'
																: 'bg-slate-50 dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:border-blue-300 dark:hover:border-blue-600'
														} ${
															isAssigned ? 'opacity-40 grayscale' : ''
														} ${
															isMaybe
																? 'border-yellow-300 bg-yellow-50 dark:bg-yellow-900/20 dark:border-yellow-700'
																: ''
														}`}
													>
														<div>
															<div
																className={`text-base font-bold ${
																	isSelected
																		? 'text-white'
																		: 'text-slate-800 dark:text-slate-200'
																}`}
															>
																{p.name}{' '}
																{isMaybe && (
																	<span className="text-xs opacity-70">
																		(?)
																	</span>
																)}
															</div>
															<div
																className={`text-sm mt-0.5 flex items-center gap-2 ${
																	isSelected
																		? 'text-blue-100'
																		: 'text-slate-500 dark:text-slate-400'
																}`}
															>
																<span>{p.weight} kg</span>
															</div>
														</div>
														<div className="flex gap-1 items-center justify-center">
															{p.skills?.includes('left') && (
																<span className="w-5 h-4 flex items-center justify-center rounded border text-[9px] font-bold bg-red-50 text-red-600 border-red-100 dark:bg-red-900/50 dark:text-red-300 dark:border-red-800">
																	L
																</span>
															)}
															{p.skills?.includes('right') && (
																<span className="w-5 h-4 flex items-center justify-center rounded border text-[9px] font-bold bg-green-50 text-green-600 border-green-100 dark:bg-green-900/50 dark:text-green-300 dark:border-green-800">
																	R
																</span>
															)}
															{p.skills?.includes('drum') && (
																<span className="w-5 h-4 flex items-center justify-center rounded border text-[9px] font-bold bg-yellow-50 text-yellow-600 border-yellow-100 dark:bg-yellow-900/50 dark:text-yellow-300 dark:border-yellow-800">
																	<Drum size={10} />
																</span>
															)}
															{p.skills?.includes('steer') && (
																<span className="w-5 h-4 flex items-center justify-center rounded border text-[9px] font-bold bg-purple-50 text-purple-600 border-purple-100 dark:bg-purple-900/50 dark:text-purple-300 dark:border-purple-800">
																	<ShipWheel size={10} />
																</span>
															)}
														</div>
													</div>
												);
											})}
										</div>
									</div>
								</div>

								<div className="lg:col-span-2 pb-10">
									<div className="bg-blue-100/30 dark:bg-blue-900/20 p-4 md:p-8 rounded-3xl border border-blue-100 dark:border-blue-800 min-h-[800px] flex justify-center items-start overflow-y-auto relative">
										<div
											className="absolute inset-0 opacity-10 pointer-events-none"
											style={{
												backgroundImage:
													'radial-gradient(circle at 10px 10px, #3b82f6 1px, transparent 0)',
												backgroundSize: '30px 30px',
											}}
										></div>
										<div
											ref={boatRef}
											className="relative w-[360px] flex flex-col items-center"
										>
											<div
												className="z-20 mb-[-15px] relative drop-shadow-xl filter"
												style={{ zIndex: 30 }}
											>
												<DragonLogo className="w-24 h-24 text-amber-600 dark:text-amber-500" />
											</div>
											<div
												className="relative bg-amber-50 dark:bg-amber-900 border-4 border-amber-800 dark:border-amber-950 shadow-xl w-full px-4 py-12 z-10"
												style={{
													clipPath:
														'polygon(50% 0%, 80% 2%, 95% 10%, 100% 45%, 100% 55%, 95% 90%, 80% 98%, 50% 100%, 20% 98%, 5% 90%, 0% 55%, 0% 45%, 5% 10%, 20% 2%)',
													borderRadius: '40px',
												}}
											>
												<div
													className="absolute pointer-events-none z-0 transition-all duration-500 ease-out"
													style={{
														left: `${cgStats.x}%`,
														top: `${cgStats.y}%`,
														transform: 'translate(-50%, -50%)',
													}}
												>
													<div className="absolute w-px h-full bg-slate-300 left-1/2 top-0 -translate-x-1/2 opacity-30"></div>
													<div className="absolute w-full h-px bg-slate-300 top-1/2 left-0 -translate-y-1/2 opacity-30"></div>
													{!isExporting && (
														<>
															<div className="w-6 h-6 rounded-full bg-red-500/30 animate-ping absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
															<div className="w-3 h-3 rounded-full bg-red-600 border-2 border-white shadow-sm absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center justify-center">
																<Target size={10} className="text-white" />
															</div>
															<div className="absolute top-4 left-1/2 -translate-x-1/2 whitespace-nowrap text-[8px] font-bold uppercase text-red-500 bg-white/80 px-1 rounded shadow-sm border border-red-100">
																Schwerpunkt
															</div>
														</>
													)}
												</div>

												<div className="space-y-3 pt-6 pb-6 relative z-10">
													<div className="flex justify-center mb-8">
														{(() => {
															const s = boatConfig[0];
															const p = paddlers.find(
																(x) => x.id === assignments[s.id]
															);
															const isMaybe =
																activeEvent &&
																activeEvent.attendance[p?.id] === 'maybe';
															return (
																<SeatBox
																	seat={s}
																	paddler={p}
																	isMaybe={isMaybe}
																	isLocked={lockedSeats.includes(s.id)}
																	isSelected={selectedPaddlerId}
																	onClick={() => handleSeatClick(s.id)}
																	onUnassign={(e) =>
																		handleUnassign(s.id, e)
																	}
																	onLock={(e) => toggleLock(s.id, e)}
																	getSkillBadges={getSkillBadges}
																	hideWeight={isExporting}
																/>
															);
														})()}
													</div>
													{Array.from({ length: rows }).map((_, i) => {
														const r = i + 1;
														const ls = `row-${r}-left`,
															rs = `row-${r}-right`;
														const pl = paddlers.find(
															(x) => x.id === assignments[ls]
														);
														const pr = paddlers.find(
															(x) => x.id === assignments[rs]
														);
														const ml =
															activeEvent &&
															activeEvent.attendance[pl?.id] === 'maybe';
														const mr =
															activeEvent &&
															activeEvent.attendance[pr?.id] === 'maybe';
														return (
															<div
																key={r}
																className="flex items-center justify-between gap-2 relative"
															>
																<div className="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-amber-900/10 dark:text-amber-100/10 text-4xl font-black pointer-events-none z-0 select-none">
																	{r}
																</div>
																<SeatBox
																	seat={{ id: ls, side: 'left' }}
																	paddler={pl}
																	isMaybe={ml}
																	isLocked={lockedSeats.includes(ls)}
																	isSelected={selectedPaddlerId}
																	onClick={() => handleSeatClick(ls)}
																	onUnassign={(e) => handleUnassign(ls, e)}
																	onLock={(e) => toggleLock(ls, e)}
																	getSkillBadges={getSkillBadges}
																	hideWeight={isExporting}
																/>
																<SeatBox
																	seat={{ id: rs, side: 'right' }}
																	paddler={pr}
																	isMaybe={mr}
																	isLocked={lockedSeats.includes(rs)}
																	isSelected={selectedPaddlerId}
																	onClick={() => handleSeatClick(rs)}
																	onUnassign={(e) => handleUnassign(rs, e)}
																	onLock={(e) => toggleLock(rs, e)}
																	getSkillBadges={getSkillBadges}
																	hideWeight={isExporting}
																/>
															</div>
														);
													})}
													<div className="flex justify-center mt-10">
														{(() => {
															const s = boatConfig[boatConfig.length - 1];
															const p = paddlers.find(
																(x) => x.id === assignments[s.id]
															);
															const isMaybe =
																activeEvent &&
																activeEvent.attendance[p?.id] === 'maybe';
															return (
																<SeatBox
																	seat={s}
																	paddler={p}
																	isMaybe={isMaybe}
																	isLocked={lockedSeats.includes(s.id)}
																	isSelected={selectedPaddlerId}
																	onClick={() => handleSeatClick(s.id)}
																	onUnassign={(e) =>
																		handleUnassign(s.id, e)
																	}
																	onLock={(e) => toggleLock(s.id, e)}
																	getSkillBadges={getSkillBadges}
																	hideWeight={isExporting}
																/>
															);
														})()}
													</div>
												</div>
											</div>
											<div
												className="text-5xl z-20 mt-[-30px] drop-shadow-lg transform -scale-y-100 filter grayscale-[0.3] relative text-amber-600 dark:text-amber-500"
												style={{ zIndex: 30 }}
											>
												üêâ
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				);
			};

			const root = ReactDOM.createRoot(document.getElementById('root'));
			root.render(<DrachenbootPlaner />);
		</script>
	</body>
</html>
